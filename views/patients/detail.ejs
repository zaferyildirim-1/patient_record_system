<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Hasta DetayÄ±</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <%- include('../partials/topbar') %>
  <% 
    function formatDate(date) {
      if (!date) return '-';
      const d = new Date(date);
      return d.toLocaleDateString('tr-TR');
    }
  %>
  <header>
    <h1>Hasta DetaylarÄ±</h1>
    <p>Temel bilgiler ve muayene kayÄ±tlarÄ±</p>
  </header>
  <main>
    <div class="toolbar">
      <a class="button secondary" href="/">Ana Sayfa</a>
      <a class="button secondary" href="/patients">Listeye DÃ¶n</a>
      <a class="button" href="/patients/<%= patient.id %>/edit">Bilgileri GÃ¼ncelle</a>
    </div>

    <section class="card">
      <h2><%= patient.full_name %></h2>
      <div class="info-grid">
        <div>
          <span class="label">Hasta Kodu</span>
          <span><%= patient.patient_code %></span>
        </div>
        <div>
          <span class="label">YaÅŸ</span>
          <span><%= patient.age %></span>
        </div>
        <div>
          <span class="label">DoÄŸum Tarihi</span>
          <span><%= formatDate(patient.birth_date) %></span>
        </div>
        <div>
          <span class="label">Cep NumarasÄ±</span>
          <span><%= patient.phone_number || '-' %></span>
        </div>
        <div>
          <span class="label">KayÄ±t SayÄ±sÄ±</span>
          <span><%= records.length %></span>
        </div>
      </div>
      <p class="meta">Son gÃ¼ncelleme: <%= formatDate(patient.updated_at ? patient.updated_at.split(' ')[0] : null) %></p>
    </section>

    <!-- SaÄŸlÄ±k Bilgileri -->
    <section class="card">
      <h2>ğŸ“‹ SaÄŸlÄ±k Bilgileri</h2>
      <div class="info-grid">
        <div>
          <span class="label">Kronik HastalÄ±klar</span>
          <div style="background: #f9f9f9; padding: 8px; border-radius: 3px; min-height: 30px;">
            <% if (patient.chronic_conditions && patient.chronic_conditions.length > 0) { %>
              <% patient.chronic_conditions.forEach(condition => { %>
                <div>â€¢ <%= condition %></div>
              <% }); %>
            <% } else { %>
              <em style="color: #999;">KayÄ±t yok</em>
            <% } %>
          </div>
        </div>
        <div>
          <span class="label">Ä°laÃ§lar</span>
          <div style="background: #f9f9f9; padding: 8px; border-radius: 3px; min-height: 30px;">
            <% if (patient.medications && patient.medications.length > 0) { %>
              <% patient.medications.forEach(med => { %>
                <div>â€¢ <%= med %></div>
              <% }); %>
            <% } else { %>
              <em style="color: #999;">KayÄ±t yok</em>
            <% } %>
          </div>
        </div>
        <div>
          <span class="label">Alerji / Ä°laÃ§ Ä°ntoleransÄ±</span>
          <div style="background: #f9f9f9; padding: 8px; border-radius: 3px; min-height: 30px;">
            <% if (patient.allergies && patient.allergies.length > 0) { %>
              <% patient.allergies.forEach(allergy => { %>
                <div>â€¢ <%= allergy %></div>
              <% }); %>
            <% } else { %>
              <em style="color: #999;">KayÄ±t yok</em>
            <% } %>
          </div>
        </div>
        <div>
          <span class="label">GeÃ§miÅŸ Operasyonlar</span>
          <div style="background: #f9f9f9; padding: 8px; border-radius: 3px; min-height: 30px;">
            <% if (patient.past_surgeries && patient.past_surgeries.length > 0) { %>
              <% patient.past_surgeries.forEach(surgery => { %>
                <div>â€¢ <%= surgery %></div>
              <% }); %>
            <% } else { %>
              <em style="color: #999;">KayÄ±t yok</em>
            <% } %>
          </div>
        </div>
      </div>
    </section>

    <!-- Acil Durum KiÅŸi -->
    <% if (patient.emergency_contact_name || patient.emergency_contact_phone) { %>
      <section class="card">
        <h3>Acil Durum KiÅŸi</h3>
        <div class="info-grid">
          <div>
            <span class="label">Ad Soyad</span>
            <span><%= patient.emergency_contact_name || '-' %></span>
          </div>
          <div>
            <span class="label">Telefon</span>
            <span><%= patient.emergency_contact_phone || '-' %></span>
          </div>
        </div>
      </section>
    <% } %>

    <section class="card">
      <details class="accordion">
        <summary class="accordion-summary">
          <span>Yeni Muayene Ekle</span>
        </summary>
        <div class="accordion-body">
          <form action="/patients/<%= patient.id %>/records" method="POST">
            <div class="form-grid">
              <div>
                <label for="visit_date">Ziyaret Tarihi *</label>
                <input type="date" id="visit_date" name="visit_date" required lang="tr-TR">
              </div>
              <div>
                <label for="visit_type">Muayene TÃ¼rÃ¼</label>
                <input type="text" id="visit_type" name="visit_type" value="" placeholder="Ã–r: Kontrol, Ä°lk Muayene">
              </div>
            </div>
            <div class="form-grid">
              <div>
                <label for="last_menstrual_date">SAT (Son Adet Tarihi)</label>
                <input type="date" id="last_menstrual_date" name="last_menstrual_date" value="" lang="tr-TR">
              </div>
              <div>
                <label for="menstrual_day">Adetin KaÃ§Ä±ncÄ± GÃ¼nÃ¼</label>
                <input type="text" id="menstrual_day" name="menstrual_day" value="" placeholder="Ã–r: 3">
              </div>
            </div>
            <div>
              <label for="complaint">Åikayet</label>
              <textarea id="complaint" name="complaint"></textarea>
            </div>
            <div>
              <label for="diagnosis">Muayene BulgularÄ± ve TeÅŸhis</label>
              <textarea id="diagnosis" name="diagnosis"></textarea>
            </div>
            <div>
              <label for="usg">Ultrason ve Laboratuvar BulgularÄ±</label>
              <textarea id="usg" name="usg" rows="3"></textarea>
            </div>
            <div>
              <label for="outcome">SonuÃ§ - Tedavi - ReÃ§ete</label>
              <textarea id="outcome" name="outcome"></textarea>
            </div>
            <button type="submit">Muayene KaydÄ±nÄ± Ekle</button>
          </form>
        </div>
      </details>
    </section>

    <section>
      <h2>Muayene GeÃ§miÅŸi</h2>
      <% if (!records.length) { %>
        <p>Bu hasta iÃ§in muayene kaydÄ± bulunmuyor.</p>
      <% } else { %>
        <div class="record-stack">
            <% records.forEach((record) => { const visitNumber = record.displayVisitOrder || record.visit_order || 1; %>
            <div class="record-card">
              <div class="record-header">
                  <div class="record-title-stack">
                    <strong><%= visitNumber %>. Ziyaret</strong>
                    <span class="record-badge"><%= formatDate(record.visit_date) %> tarihli ziyaret</span>
                    <span class="record-meta">Toplam <%= visitNumber %> kez geldi<% if (record.visit_week) { %> &middot; <%= record.visit_week %><% } %></span>
                </div>
                <div style="display: flex; gap: 8px;">
                  <a class="button secondary" href="/patients/<%= patient.id %>/records/<%= record.id %>/edit">DÃ¼zenle</a>
                  <form class="inline" action="/patients/<%= patient.id %>/records/<%= record.id %>/delete" method="POST" onsubmit="return confirm('KaydÄ± silmek istediÄŸinize emin misiniz?');">
                    <button class="danger" type="submit">Sil</button>
                  </form>
                </div>
              </div>
              <% if (record.visit_type) { %>
                <p><span class="label">Muayene TÃ¼rÃ¼:</span> <%= record.visit_type %></p>
              <% } %>
              <% if (record.last_menstrual_date) { %>
                <p><span class="label">SAT (Son Adet Tarihi):</span> <%= formatDate(record.last_menstrual_date) %><% if (record.menstrual_day) { %> <span class="label">&middot; Adetin <%= record.menstrual_day %>. gÃ¼nÃ¼</span><% } %></p>
              <% } %>
              <p><span class="label">Åikayet:</span> <%= record.complaint || 'BelirtilmemiÅŸ' %></p>
              <% if (record.usg) { %>
                <p><span class="label">USG:</span> <%= record.usg %></p>
              <% } %>
              <p><span class="label">TeÅŸhis:</span> <%= record.diagnosis || 'BelirtilmemiÅŸ' %></p>
              <p><span class="label">SonuÃ§ - Tedavi - ReÃ§ete:</span> <%= record.outcome || 'BelirtilmemiÅŸ' %></p>
            </div>
          <% }); %>
        </div>
      <% } %>
    </section>

    <form action="/patients/<%= patient.id %>/delete" method="POST" onsubmit="return confirm('KaydÄ± silmek istediÄŸinize emin misiniz?');">
      <button class="danger" type="submit">HastayÄ± Sil</button>
    </form>
  </main>
</body>
</html>
