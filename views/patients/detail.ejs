<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Hasta Detayı</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <%- include('../partials/topbar') %>
  <header>
    <h1>Hasta Detayları</h1>
    <p>Temel bilgiler ve muayene kayıtları</p>
  </header>
  <main>
    <div class="toolbar">
      <a class="button secondary" href="/">Ana Sayfa</a>
      <a class="button secondary" href="/patients">Listeye Dön</a>
      <a class="button" href="/patients/<%= patient.id %>/edit">Bilgileri Güncelle</a>
    </div>

    <section class="card">
      <h2><%= patient.full_name %></h2>
      <div class="info-grid">
        <div>
          <span class="label">Hasta Kodu</span>
          <span><%= patient.patient_code %></span>
        </div>
        <div>
          <span class="label">Yaş</span>
          <span><%= patient.age %></span>
        </div>
        <div>
          <span class="label">Doğum Tarihi</span>
          <span><%= formatDate(patient.birth_date) %></span>
        </div>
        <div>
          <span class="label">Cep Numarası</span>
          <span><%= patient.phone_number || '-' %></span>
        </div>
        <div>
          <span class="label">Kayıt Sayısı</span>
          <span><%= records.length %></span>
        </div>
      </div>
      <p class="meta">Son güncelleme: <%= formatDate(patient.updated_at ? patient.updated_at.split(' ')[0] : null) %></p>
    </section>

    <section class="card">
      <details class="accordion" <%= recordErrors.length ? 'open' : '' %>>
        <summary class="accordion-summary">
          <span>Yeni Muayene Ekle</span>
        </summary>
        <div class="accordion-body">
          <% if (recordErrors.length) { %>
            <div class="alert">Lütfen şu alanları doldurun: <%= recordErrors.join(', ') %></div>
          <% } %>
          <form action="/patients/<%= patient.id %>/records" method="POST">
            <div class="form-grid">
              <div>
                <label for="visit_date">Ziyaret Tarihi *</label>
                <input type="date" id="visit_date" name="visit_date" value="<%= recordDraft?.visit_date || '' %>" required lang="tr-TR">
              </div>
              <div>
                <label for="visit_type">Muayene Türü</label>
                <input type="text" id="visit_type" name="visit_type" value="<%= recordDraft?.visit_type || '' %>" placeholder="Ör: Kontrol, İlk Muayene">
              </div>
            </div>
            <div class="form-grid">
              <div>
                <label for="last_menstrual_date">SAT (Son Adet Tarihi)</label>
                <input type="date" id="last_menstrual_date" name="last_menstrual_date" value="<%= recordDraft?.last_menstrual_date || '' %>" lang="tr-TR">
              </div>
              <div>
                <label for="menstrual_day">Adetin Kaçıncı Günü</label>
                <input type="text" id="menstrual_day" name="menstrual_day" value="<%= recordDraft?.menstrual_day || '' %>" placeholder="Ör: 3">
              </div>
            </div>
            <div>
              <label for="complaint">Şikayet</label>
              <textarea id="complaint" name="complaint"><%= recordDraft?.complaint || '' %></textarea>
            </div>
            <div>
              <label for="usg">USG</label>
              <textarea id="usg" name="usg" rows="3"><%= recordDraft?.usg || '' %></textarea>
            </div>
            <div>
              <label for="diagnosis">Teşhis</label>
              <textarea id="diagnosis" name="diagnosis"><%= recordDraft?.diagnosis || '' %></textarea>
            </div>
            <div>
              <label for="outcome">Sonuç - Tedavi - Reçete</label>
              <textarea id="outcome" name="outcome"><%= recordDraft?.outcome || '' %></textarea>
            </div>
            <button type="submit">Muayene Kaydını Ekle</button>
          </form>
        </div>
      </details>
    </section>

    <section>
      <h2>Muayene Geçmişi</h2>
      <% if (!records.length) { %>
        <p>Bu hasta için muayene kaydı bulunmuyor.</p>
      <% } else { %>
        <div class="record-stack">
            <% records.forEach((record) => { const visitNumber = record.displayVisitOrder || record.visit_order || 1; %>
            <div class="record-card">
              <div class="record-header">
                  <div class="record-title-stack">
                    <strong><%= visitNumber %>. Ziyaret</strong>
                    <span class="record-badge"><%= formatDate(record.visit_date) %> tarihli ziyaret</span>
                    <span class="record-meta">Toplam <%= visitNumber %> kez geldi<% if (record.visit_week) { %> &middot; <%= record.visit_week %><% } %></span>
                </div>
                <div style="display: flex; gap: 8px;">
                  <a class="button secondary" href="/patients/<%= patient.id %>/records/<%= record.id %>/edit">Düzenle</a>
                  <form class="inline" action="/patients/<%= patient.id %>/records/<%= record.id %>/delete" method="POST" onsubmit="return confirm('Kaydı silmek istediğinize emin misiniz?');">
                    <button class="danger" type="submit">Sil</button>
                  </form>
                </div>
              </div>
              <% if (record.visit_type) { %>
                <p><span class="label">Muayene Türü:</span> <%= record.visit_type %></p>
              <% } %>
              <% if (record.last_menstrual_date) { %>
                <p><span class="label">SAT (Son Adet Tarihi):</span> <%= formatDate(record.last_menstrual_date) %><% if (record.menstrual_day) { %> <span class="label">&middot; Adetin <%= record.menstrual_day %>. günü</span><% } %></p>
              <% } %>
              <p><span class="label">Şikayet:</span> <%= record.complaint || 'Belirtilmemiş' %></p>
              <% if (record.usg) { %>
                <p><span class="label">USG:</span> <%= record.usg %></p>
              <% } %>
              <p><span class="label">Teşhis:</span> <%= record.diagnosis || 'Belirtilmemiş' %></p>
              <p><span class="label">Sonuç - Tedavi - Reçete:</span> <%= record.outcome || 'Belirtilmemiş' %></p>
            </div>
          <% }); %>
        </div>
      <% } %>
    </section>

    <form action="/patients/<%= patient.id %>/delete" method="POST" onsubmit="return confirm('Kaydı silmek istediğinize emin misiniz?');">
      <button class="danger" type="submit">Hastayı Sil</button>
    </form>
  </main>
</body>
</html>
