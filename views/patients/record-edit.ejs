<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Muayene KaydÄ±nÄ± DÃ¼zenle</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <%- include('../partials/topbar') %>
  <header>
    <h1>Muayene KaydÄ±nÄ± DÃ¼zenle</h1>
    <p><%= patient.full_name %> (<%= patient.patient_code %>)</p>
  </header>
  <main>
    <div class="toolbar">
      <a class="button secondary" href="/">Ana Sayfa</a>
      <a class="button secondary" href="/patients">Hasta Listesi</a>
      <a class="button secondary" href="/patients/<%= patient.id %>">Hasta Detay</a>
    </div>

    <% if (errors.length) { %>
      <div class="alert">
        <%= errors.join(', ') %>
      </div>
    <% } %>

    <form action="/patients/<%= patient.id %>/records/<%= record.id %>/update" method="POST">
      <div>
        <label for="visit_date">Muayene Tarihi *</label>
        <input type="date" id="visit_date" name="visit_date" value="<%= record.visit_date %>" required lang="tr-TR">
      </div>

      <div>
        <label for="visit_type">Muayene TÃ¼rÃ¼</label>
        <input type="text" id="visit_type" name="visit_type" value="<%= record.visit_type || '' %>">
      </div>

      <!-- Ä°liÅŸkili SaÄŸlÄ±k GeÃ§miÅŸi (from patient registry) -->
      <fieldset style="background: #f9f9f9; padding: 15px; margin: 20px 0; border-left: 4px solid #007bff; border-radius: 4px;">
        <legend style="font-weight: bold; color: #333;">ğŸ“‹ Ä°liÅŸkili SaÄŸlÄ±k GeÃ§miÅŸi (HastanÄ±n KayÄ±tlarÄ±ndan)</legend>
        
        <div class="form-grid">
          <div>
            <label><strong>Kronik HastalÄ±klar:</strong></label>
            <div style="background: white; padding: 8px; border-radius: 3px; min-height: 30px;">
              <% if (patient.chronic_conditions && patient.chronic_conditions.length > 0) { %>
                <%= patient.chronic_conditions.join(', ') %>
              <% } else { %>
                <em style="color: #999;">KayÄ±tlÄ± kronik hastalÄ±k yok</em>
              <% } %>
            </div>
            <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">
              <input type="checkbox" id="toggle_chronic" onclick="toggleAdd('chronic_section')"> Yeni hastalÄ±k ekle
            </p>
            <div id="chronic_section" style="display:none; margin-top: 8px;">
              <textarea name="additional_chronic_conditions" rows="2" placeholder="Yeni kronik hastalÄ±k ekle..." style="width: 100%;"></textarea>
            </div>
          </div>

          <div>
            <label><strong>Ä°laÃ§lar:</strong></label>
            <div style="background: white; padding: 8px; border-radius: 3px; min-height: 30px;">
              <% if (patient.medications && patient.medications.length > 0) { %>
                <%= patient.medications.join(', ') %>
              <% } else { %>
                <em style="color: #999;">KayÄ±tlÄ± ilaÃ§ yok</em>
              <% } %>
            </div>
            <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">
              <input type="checkbox" id="toggle_meds" onclick="toggleAdd('meds_section')"> Yeni ilaÃ§ ekle
            </p>
            <div id="meds_section" style="display:none; margin-top: 8px;">
              <textarea name="additional_medications" rows="2" placeholder="Yeni ilaÃ§ ekle..." style="width: 100%;"></textarea>
            </div>
          </div>
        </div>

        <div class="form-grid">
          <div>
            <label><strong>Alerjiler:</strong></label>
            <div style="background: white; padding: 8px; border-radius: 3px; min-height: 30px;">
              <% if (patient.allergies && patient.allergies.length > 0) { %>
                <%= patient.allergies.join(', ') %>
              <% } else { %>
                <em style="color: #999;">KayÄ±tlÄ± alerji yok</em>
              <% } %>
            </div>
            <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">
              <input type="checkbox" id="toggle_allergies" onclick="toggleAdd('allergies_section')"> Yeni alerji ekle
            </p>
            <div id="allergies_section" style="display:none; margin-top: 8px;">
              <textarea name="additional_allergies" rows="2" placeholder="Yeni alerji ekle..." style="width: 100%;"></textarea>
            </div>
          </div>

          <div>
            <label><strong>GeÃ§miÅŸ Operasyonlar:</strong></label>
            <div style="background: white; padding: 8px; border-radius: 3px; min-height: 30px;">
              <% if (patient.past_surgeries && patient.past_surgeries.length > 0) { %>
                <%= patient.past_surgeries.join(', ') %>
              <% } else { %>
                <em style="color: #999;">KayÄ±tlÄ± operasyon yok</em>
              <% } %>
            </div>
            <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">
              <input type="checkbox" id="toggle_surgeries" onclick="toggleAdd('surgeries_section')"> Yeni operasyon ekle
            </p>
            <div id="surgeries_section" style="display:none; margin-top: 8px;">
              <textarea name="additional_surgeries" rows="2" placeholder="Yeni operasyon ekle..." style="width: 100%;"></textarea>
            </div>
          </div>
        </div>
      </fieldset>

      <div class="form-grid">
        <div>
          <label for="last_menstrual_date">SAT (Son Adet Tarihi)</label>
          <input type="date" id="last_menstrual_date" name="last_menstrual_date" value="<%= record.last_menstrual_date || '' %>" lang="tr-TR">
        </div>
        <div>
          <label for="menstrual_day">Adetin KaÃ§Ä±ncÄ± GÃ¼nÃ¼</label>
          <input type="text" id="menstrual_day" name="menstrual_day" value="<%= record.menstrual_day || '' %>" placeholder="Ã–r: 3">
        </div>
      </div>

      <div>
        <label for="complaint">Åikayet</label>
        <textarea id="complaint" name="complaint" rows="4"><%= record.complaint || '' %></textarea>
      </div>

      <div>
        <label for="usg">USG</label>
        <textarea id="usg" name="usg" rows="3"><%= record.usg || '' %></textarea>
      </div>

      <div>
        <label for="diagnosis">TeÅŸhis</label>
        <textarea id="diagnosis" name="diagnosis" rows="4"><%= record.diagnosis || '' %></textarea>
      </div>

      <div>
        <label for="outcome">SonuÃ§ - Tedavi - ReÃ§ete</label>
        <textarea id="outcome" name="outcome" rows="4"><%= record.outcome || '' %></textarea>
      </div>

      <button type="submit">GÃ¼ncelle</button>
      <a class="button secondary" href="/patients/<%= patient.id %>">Ä°ptal</a>
    </form>
  </main>

  <script>
    function toggleAdd(sectionId) {
      const section = document.getElementById(sectionId);
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }
  </script>
</body>
</html>
